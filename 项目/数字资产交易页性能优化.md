## 项目背景
针对千万级日活的数字资产交易平台，聚焦核心交易页（覆盖现货、合约等多场景）存在高频数据更新延迟、组件重渲染冗余、交互响应卡顿等问题，牵头主导核心交易页性能极致优化项目，通过重构数据流、优化渲染机制及建立性能标准，提升用户交易体验与系统稳定性，目标将核心性能指标超越竞品 20%。

## 技术栈
+ 框架与语言：Next.js（SSR+ISR 混合渲染）、TypeScript（类型安全开发）
+ 状态与数据流：MobX（状态管理）、RXJS（异步数据流处理）、SWR（数据缓存与实时更新）
+ 工程化与工具：ESLint（代码规范）、qiankun（微前端集成）、workbox（PWA 离线缓存）
+ UI 与交互：Tailwind CSS（原子化样式）、styled-components（组件样式隔离）、ahooks（高频 hooks 封装）
+ 业务工具：big.js（高精度数字计算）、i18next（多语言适配）

## 主要职责与技术实现
1. 性能标准体系建立与监控闭环
    + 制定多维度性能标准：加载阶段、运行时、视觉稳定性、资源体积，覆盖现货/合约等不同交易场景。
2. 搭建实时监控链路：
    + 通过sdk采集性能数据：Web Vitals + Performance API + 自定义埋点
        - 聚焦web vitals核心指标：FCP、LCP、INP、CLS等
        - 页面加载时间：loadEventEnd - navigationStart
        - JS 执行时间和资源加载时间
        - 网络请求性能（接口响应时间、失败率等）
    + 监控内存、CPU占用情况（CPU 占用峰值，尤其是复杂计算模块）
    + 通过Playwright（升级版puppeteer） + PageSpeed写脚本自动刷新采集竟品指标数据，固定变量（浏览器、网络环境、设备），上报到监控平台。
        - Playwright：自动化浏览器操作，可以模拟用户行为，如打开页面、点击按钮、滚动页面等
        - PageSpeed：分析页面性能，提供 Web Vitals、加载时间、响应时间、可访问性等性能指标
3. 对比分析和竟品在关键指标上的差异，统一汇总在可视化平台上。
4. 核心指标优化方案落地
    + next内置优化：
        - 自动代码分割：每个页面只加载自己所需的 JS/CSS，不会加载整个应用的 bundle。
        - next/dynamic 动态加载
        - next/image 默认支持图片压缩、懒加载、根据设备分辨率自动转换
        - next/script 支持多种三方脚本加载方式，避免阻塞
        - 自动 tree-shaking
        - 缓存机制
        - 提取关键css内联到HTML中，避免阻塞渲染
    + 加载性能优化：
        - 交易页头部实时行情采用 SSR 预渲染，用户可以快速看到页面。
        - 动态加载：对于首屏不可见的模块，通过next/dynamic动态加载
        - 基于 next-pwa 实现 PWA 离线缓存，将静态资源（CSS / 图片 / 字体）缓存至 Service Worker；
        - Early Hints：服务器在完整的响应主体生成之前，提前发送部分信息，特别是在高延迟的请求中，让客户端可以提前预加载资源（js、css、字体等）。（nginx、cdn），而传统的预加载需要等待获取到完整的html之后才知道预加载哪些资源，这个中间的时间就浪费掉了。（适用于ssr项目）
        - 开启http3.0和br压缩（cloudflare支持）
        - 静态资源cdn分发（cloudflare）
    + 渲染与交互优化：
        - 通过 rxjs 减少数据更新频次，降低渲染频率；
        - mobx响应式更新，并且通过runInAction批处理更新
        - react.memo、useMemo、useCallback、useTransition的合理使用
        + 重构状态管理：拆分store，之前的代码将多个不相关的状态放在同一个store中进行管理，导致一些不必要的更新。
        + 复杂计算放到web worker执行，比如合约仓位模块（合约仓位有个可实现营收，仓位多了，计算cpu跑到90多了）
5. 发布前后指标对比，验证优化效果，继续监控和优化

## 基础图（蜡烛图）、TradingView、深度图
1. 基础图：用于展示资产价格的历史走势，其功能相对简单，数据主要来自交易所自身的交易数据记录，可定制度较低。基于klineCharts实现，但体验不是太好。
2. TradingView：提供更丰富的技术分析指标（如移动平均线、RSI、MACD 等），支持自定义图表布局，用户可根据需求添加或移除指标，不仅可以获取交易所的交易数据，还能汇聚全球多个市场的数据，可定制度高
3. 深度图：展示资产价格的深度分布，即展示不同价格水平上的订单量（买盘量与卖盘量），帮助用户了解市场供需情况，同时也可以用于识别潜在的交易机会。

## 深度图实现
1. Canvas 绘制，分别展示买盘量与卖盘量。
2. 快照+增量更新，初次加载时全量获取数据，后续通过 WebSocket 实时推送增量数据，动态更新图表。
    - 初始化：
        1. 前端接收 books (snapshot) 数据，解析为 bids/asks 数组，记录当前 timestamp。
        2. 初始化 Canvas 图表，设置 buy/sell 两个面积图。
    - 增量更新：
        1. 前端持续接收 delta updates，严格校验顺序，按 price 排序。
        2. applyDelta 到 bids/asks Map 中，合并相同 price 下的数量。
        3. 对 bids/asks 数组排序，截断前 100 档，计算累积量。
        4. 调用 Canvas 更新 buy/sell 面积图。
3. 计算累积数量
4. 更新渲染
5. 性能优化：
    - 增量更新时，仅更新变化的 price 对应的 buy/sell 数据，避免全量重绘。
    - 虽然订单簿更新频率高，但视觉上每秒 30 次刷新已足够流畅，因此前端会对渲染逻辑进行节流（如每 33ms 执行一次），减少无效计算。
    - 订单簿数据的合并、累计数量计算等耗时操作放在 WebWorker 中执行，避免阻塞主线程的渲染流程，确保界面不卡顿
    - 深度图仅展示前 100 档

## k线图
1. K 线图，原名蜡烛图，又称阴阳图、棒线、红黑线或蜡烛线，常用于展示股票/虚拟货币交易数据。K 线就是指将各种股票每日、每周、每月的开盘价、收盘价、最高价、最低价等涨跌变化状况，用图形的方式表现出来
2. 基于kline charts或者lightweight charts