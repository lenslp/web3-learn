## Aiot大门禁系统
1. 项目背景：包含门禁、人员、空间、考勤等多个模块，且涉及多业务部门协作，所以在架构上采用微前端的方式，每个子应用之间独立部署，互不影响。
2. 踩坑：
    + 通过git submodules的方式引入公共组件，相同的组件代码会被重复编译和打包到每个子项目的产物中。
    + 开发体验不佳，修改公共组件后需要额外的提交和推送，子应用中也需要重新拉取，并且可能会存在冲突
    + 克隆项目、ci/cd 都需要额外的配置
    + 随着子应用越来越多，打包越来越慢
3. 解决：放弃使用git submodules，改用module federation的方式。

## module federation
Webpack 5引入的一个革命性特性，主要用于解决微前端架构中的代码共享问题。它允许不同应用间动态加载和共享代码模块，实现真正的跨应用代码复用。
+ 不同应用之间可以共享代码
+ 不同应用之间可以共用公共依赖，避免重复加载相同的依赖，减少应用包体积，提高性能。
+ 按需加载模块，减少初始体积

## hooks无法使用
1. 问题：使用module federation导出的组件，无法使用hooks
    + useState 由 remote 的 React 实例执行
    + Fiber 树却属于 host 的 React 实例
    + React 会认为“你正在其他渲染器内调用 Hook”
2. 排查：宿主应用和远程应用都安装了react，多个react实例导致执行hooks时上下文不一致
3. 解决：
    + 保证主应用和子应用共享同一个react实例，通过配置shared(主子应用都要配置)
        - 子应用不会再把自己的 react 打包进 bundle（因为 shared 会排除掉它）
    + 主应用安装react，子应用只在 peerDependencies 中声明 react
    + 主应用和子应用的react版本保持一致
```typescript
new ModuleFederationPlugin({
  remotes: { ... },
  shared: {
    react: {
      singleton: true,
      requiredVersion: deps.react,
    },
    "react-dom": {
      singleton: true,
      requiredVersion: deps["react-dom"],
    },
  }
})
```

## 高德地图隔离问题
1. 问题：子应用中有使用高德地图时，可能会加载不出来
2. 排查：
    + qiankun加载子应用是动态加载，页面是按需渲染的，有可能子应用执行useEffect时，DOM 可能并没有完全挂载好。
    + 主、子应用各自创建一个地图实例，打包的时候也会各自打包一份到bundle中，增加了包体积（可以通过module federation 的shared配置解决）
3. 解决：
    + 通过设置settimeout延迟地图init的执行
    + 通过React.lazy + Suspense 加载地图组件

## git submodules
Git Submodules 是 Git 提供的一种功能，允许将一个 Git 仓库作为另一个 Git 仓库的子目录。这种机制可以让一个主项目中引用和管理其他独立的项目或代码库。
+ 主仓库使用特殊的 "gitlink" 文件类型引用子模块，gitlink 文件存储子模块的提交哈希值
+ 每个子模块维护自己独立的 Git 历史和状态
+ Git 不会自动同步子模块的更新，需要手动拉取更新

